<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>api.json_ai &mdash; lightwood 1.1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="../../index.html">
            <img src="../../_static/mindsdblogo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../lightwood_philosophy.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Lightwood</span> <span class="pre">Philosophy</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Tutorials</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">API</span> <span class="pre">Module</span></code></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">lightwood</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>api.json_ai</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for api.json_ai</h1><div class="highlight"><pre>
<span></span><span class="c1"># TODO: We need a better way to specify trainable_encoders</span>
<span class="c1"># TODO: lookup_encoder is awkward; similar to dtype, can we make a file with encoder_lookup? People may be interested in seeing where these come from and it&#39;s not clear that you need to look here.</span>
<span class="c1"># TODO: What does `target_class_distribution` and `positive_domain` do?</span>
<span class="c1"># TODO: generate_json_ai is really large; can we abstract it into smaller functions to make it more readable?</span>
<span class="c1"># TODO: add_implicit_values unit test ensures NO changes for a fully specified file.</span>
<span class="c1"># TODO: Please fix spelling on parallel_preped_encoders</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">lightwood.helpers.templating</span> <span class="k">import</span> <span class="n">call</span><span class="p">,</span> <span class="n">inline_dict</span><span class="p">,</span> <span class="n">align</span>
<span class="kn">import</span> <span class="nn">autopep8</span>
<span class="kn">from</span> <span class="nn">lightwood.api</span> <span class="k">import</span> <span class="n">dtype</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">lightwood.api.types</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">JsonAI</span><span class="p">,</span>
    <span class="n">TypeInformation</span><span class="p">,</span>
    <span class="n">StatisticalAnalysis</span><span class="p">,</span>
    <span class="n">Feature</span><span class="p">,</span>
    <span class="n">Output</span><span class="p">,</span>
    <span class="n">ProblemDefinition</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">trainable_encoders</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;PretrainedLangEncoder&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CategoricalAutoEncoder&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TimeSeriesEncoder&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TimeSeriesPlainEncoder&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ts_encoders</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;TimeSeriesEncoder&quot;</span><span class="p">,</span> <span class="s2">&quot;TimeSeriesPlainEncoder&quot;</span><span class="p">,</span> <span class="s2">&quot;TsNumericEncoder&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="lookup_encoder"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.lookup_encoder">[docs]</a><span class="k">def</span> <span class="nf">lookup_encoder</span><span class="p">(</span>
    <span class="n">col_dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">is_target</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">problem_defintion</span><span class="p">:</span> <span class="n">ProblemDefinition</span><span class="p">,</span>
    <span class="n">is_target_predicting_encoder</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign a default encoder for a given column based on its data type, and whether it is a target. Encoders intake raw (but cleaned) data and return an feature representation. This function assigns, per data type, what the featurizer should be. This function runs on each column within the dataset available for model building to assign how it should be featurized.</span>

<span class="sd">    Users may override to create a custom encoder to enable their own featurization process. However, in order to generate a template JSON-AI, this code is run first. Users may edit the generated syntax and use custom approaches while model building.</span>

<span class="sd">    For each encoder, &quot;args&quot; may be passed. These args depend an encoder requires during its preparation call.</span>

<span class="sd">    :param col_dtype: A data-type of a column specified</span>
<span class="sd">    :param col_name: The name of the column</span>
<span class="sd">    :param is_target: Whether the column is the target for prediction. If true, only certain possible feature representations are allowed, particularly for complex data types.</span>
<span class="sd">    :param problem_definition: The ``ProblemDefinition`` criteria; this populates specifics on how models and encoders may be trained.</span>
<span class="sd">    :param is_target_predicting_encoder:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tss</span> <span class="o">=</span> <span class="n">problem_defintion</span><span class="o">.</span><span class="n">timeseries_settings</span>
    <span class="n">encoder_lookup</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">:</span> <span class="s2">&quot;Integer.NumericEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">:</span> <span class="s2">&quot;Float.NumericEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">:</span> <span class="s2">&quot;Binary.BinaryEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">:</span> <span class="s2">&quot;Categorical.CategoricalAutoEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span> <span class="s2">&quot;Tags.MultiHotEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">date</span><span class="p">:</span> <span class="s2">&quot;Date.DatetimeEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="s2">&quot;Datetime.DatetimeEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">image</span><span class="p">:</span> <span class="s2">&quot;Image.Img2VecEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">rich_text</span><span class="p">:</span> <span class="s2">&quot;Rich_Text.PretrainedLangEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">short_text</span><span class="p">:</span> <span class="s2">&quot;Short_Text.CategoricalAutoEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">array</span><span class="p">:</span> <span class="s2">&quot;Array.TimeSeriesEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">quantity</span><span class="p">:</span> <span class="s2">&quot;Quantity.NumericEncoder&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># If column is a target, only specific feature representations are allowed that enable supervised tasks</span>
    <span class="n">target_encoder_lookup_override</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">rich_text</span><span class="p">:</span> <span class="s2">&quot;Rich_Text.VocabularyEncoder&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">:</span> <span class="s2">&quot;Categorical.OneHotEncoder&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Assign a default encoder to each column.</span>
    <span class="n">encoder_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">encoder_lookup</span><span class="p">[</span><span class="n">col_dtype</span><span class="p">],</span> <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="c1"># If the column is a target, ensure that the feature representation can enable supervised tasks</span>
    <span class="k">if</span> <span class="n">is_target</span><span class="p">:</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;is_target&quot;</span><span class="p">:</span> <span class="s2">&quot;True&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="n">target_encoder_lookup_override</span><span class="p">:</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_encoder_lookup_override</span><span class="p">[</span><span class="n">col_dtype</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">problem_defintion</span><span class="o">.</span><span class="n">unbias_target</span><span class="p">:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;target_class_distribution&quot;</span><span class="p">:</span> <span class="s2">&quot;$statistical_analysis.target_class_distribution&quot;</span>
                <span class="p">}</span>

        <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span>
                <span class="s2">&quot;positive_domain&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$statistical_analysis.positive_domain&quot;</span>

    <span class="c1"># Time-series representations require more advanced flags</span>
    <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">is_timeseries</span><span class="p">:</span>
        <span class="n">gby</span> <span class="o">=</span> <span class="n">tss</span><span class="o">.</span><span class="n">group_by</span> <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">tss</span><span class="o">.</span><span class="n">order_by</span> <span class="o">+</span> <span class="n">tss</span><span class="o">.</span><span class="n">historical_columns</span><span class="p">:</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_dtype</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.TimeSeriesEncoder&quot;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;&quot;</span><span class="si">{col_dtype}</span><span class="s1">&quot;&#39;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;self.target&quot;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;grouped_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{gby}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">is_target</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">]:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;grouped_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{gby}</span><span class="s2">&quot;</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Integer.TsNumericEncoder&quot;</span>
            <span class="k">if</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">]:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;grouped_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{gby}</span><span class="s2">&quot;</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Float.TsNumericEncoder&quot;</span>
            <span class="k">if</span> <span class="n">tss</span><span class="o">.</span><span class="n">nr_predictions</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;grouped_by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{gby}</span><span class="s2">&quot;</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;timesteps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{tss.nr_predictions}</span><span class="s2">&quot;</span>
                <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Array.TsArrayNumericEncoder&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;__mdb_ts_previous&quot;</span> <span class="ow">in</span> <span class="n">col_name</span><span class="p">:</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_dtype</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.TimeSeriesPlainEncoder&quot;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;&quot;</span><span class="si">{tss.target_type}</span><span class="s1">&quot;&#39;</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;window&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{tss.window}</span><span class="s2">&quot;</span>

    <span class="c1"># Set arguments for the encoder</span>
    <span class="k">if</span> <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Rich_Text.PretrainedLangEncoder&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_target</span><span class="p">:</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;output_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$dtype_dict[$target]&quot;</span>

    <span class="k">for</span> <span class="n">encoder_name</span> <span class="ow">in</span> <span class="n">trainable_encoders</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">encoder_name</span> <span class="o">==</span> <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span>
                <span class="s2">&quot;stop_after&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$problem_definition.seconds_per_encoder&quot;</span>

    <span class="k">if</span> <span class="n">is_target_predicting_encoder</span><span class="p">:</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;embed_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>

    <span class="k">return</span> <span class="n">encoder_dict</span></div>


<div class="viewcode-block" id="generate_json_ai"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.generate_json_ai">[docs]</a><span class="k">def</span> <span class="nf">generate_json_ai</span><span class="p">(</span>
    <span class="n">type_information</span><span class="p">:</span> <span class="n">TypeInformation</span><span class="p">,</span>
    <span class="n">statistical_analysis</span><span class="p">:</span> <span class="n">StatisticalAnalysis</span><span class="p">,</span>
    <span class="n">problem_definition</span><span class="p">:</span> <span class="n">ProblemDefinition</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonAI</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given ``TypeInformation``, ``StatisticalAnalysis``, and the ``ProblemDefinition``, generate a JSON config file with the necessary elements of the ML pipeline populated.</span>

<span class="sd">    :param TypeInformation: Specifies what data types each column within the dataset are</span>
<span class="sd">    :param statistical_analysis:</span>
<span class="sd">    :param problem_definition: Specifies details of the model training/building procedure, as defined by ``ProblemDefinition``</span>

<span class="sd">    :returns: JSON-AI object with fully populated details of the ML pipeline</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span>
    <span class="n">input_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_dtype</span> <span class="ow">in</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">col_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">type_information</span><span class="o">.</span><span class="n">identifiers</span>
            <span class="ow">and</span> <span class="n">col_dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">invalid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">col_name</span> <span class="o">!=</span> <span class="n">target</span>
        <span class="p">):</span>
            <span class="n">input_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>

    <span class="n">is_target_predicting_encoder</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Single text column classification</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">input_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="ow">and</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">input_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">rich_text</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">is_target_predicting_encoder</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">is_target_predicting_encoder</span><span class="p">:</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;Unit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;target_encoder&quot;</span><span class="p">:</span> <span class="s2">&quot;$encoders[self.target]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_model&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;Neural&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;fit_on_dev&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_model&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;search_hyperparameters&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">is_timeseries</span>
            <span class="ow">or</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">nr_predictions</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">models</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;LightGBM&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_model&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;fit_on_dev&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;Regression&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_model&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">},</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">nr_predictions</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">models</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;LightGBMArray&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;fit_on_dev&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_model&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;n_ts_predictions&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings.nr_predictions&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">use_previous_target</span><span class="p">:</span>
                <span class="n">models</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;SkTime&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;stop_after&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.seconds_per_model&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;n_ts_predictions&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings.nr_predictions&quot;</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Output</span><span class="p">(</span>
            <span class="n">data_dtype</span><span class="o">=</span><span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">target</span><span class="p">],</span>
            <span class="n">encoder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">models</span><span class="o">=</span><span class="n">models</span><span class="p">,</span>
            <span class="n">ensemble</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;BestOf&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;accuracy_functions&quot;</span><span class="p">:</span> <span class="s2">&quot;$accuracy_functions&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">is_timeseries</span>
        <span class="ow">and</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">nr_predictions</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="p">):</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">array</span>

    <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">lookup_encoder</span><span class="p">(</span>
        <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">target</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">problem_definition</span><span class="p">,</span> <span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">features</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">input_cols</span><span class="p">:</span>
        <span class="n">col_dtype</span> <span class="o">=</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
        <span class="n">dependency</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">lookup_encoder</span><span class="p">(</span>
            <span class="n">col_dtype</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">problem_definition</span><span class="p">,</span> <span class="n">is_target_predicting_encoder</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">encoder_name</span> <span class="ow">in</span> <span class="n">ts_encoders</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">is_timeseries</span>
                <span class="ow">and</span> <span class="n">encoder_name</span> <span class="o">==</span> <span class="n">encoder</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">group_by</span><span class="p">:</span>
                        <span class="n">dependency</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">use_previous_target</span><span class="p">:</span>
                    <span class="n">dependency</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;__mdb_ts_previous_</span><span class="si">{target}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span><span class="n">encoder</span><span class="o">=</span><span class="n">encoder</span><span class="p">,</span> <span class="n">dependency</span><span class="o">=</span><span class="n">dependency</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span><span class="n">encoder</span><span class="o">=</span><span class="n">encoder</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span>

    <span class="c1"># Decide on the accuracy functions to use</span>
    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtype</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">float</span><span class="p">]:</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;r2_score&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span> <span class="o">==</span> <span class="n">dtype</span><span class="o">.</span><span class="n">categorical</span><span class="p">:</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;balanced_accuracy_score&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span> <span class="o">==</span> <span class="n">dtype</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;balanced_accuracy_score&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span> <span class="o">==</span> <span class="n">dtype</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;evaluate_array_accuracy&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">accuracy_functions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;accuracy_score&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_model</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_encoder</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">1000</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">statistical_analysis</span><span class="o">.</span><span class="n">nr_rows</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="mi">4</span>
                    <span class="k">if</span> <span class="n">x</span>
                    <span class="ow">in</span> <span class="p">[</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">rich_text</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">short_text</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">video</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">audio</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="k">else</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">type_information</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="mi">200</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nr_trainable_encoders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">x</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">encoder</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">trainable_encoders</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">nr_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">models</span><span class="p">)</span>
        <span class="n">encoder_time_budget_pct</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mf">3.3</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">1.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nr_trainable_encoders</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">nr_trainable_encoders</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_encoder</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_encoder</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">encoder_time_budget_pct</span> <span class="o">/</span> <span class="n">nr_trainable_encoders</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">problem_definition</span><span class="o">.</span><span class="n">seconds_per_model</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">problem_definition</span><span class="o">.</span><span class="n">time_aim</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">encoder_time_budget_pct</span><span class="p">)</span> <span class="o">/</span> <span class="n">nr_models</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">JsonAI</span><span class="p">(</span>
        <span class="n">cleaner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">splitter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">analyzer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">explainer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
        <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
        <span class="n">imports</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">problem_definition</span><span class="o">=</span><span class="n">problem_definition</span><span class="p">,</span>
        <span class="n">identifiers</span><span class="o">=</span><span class="n">type_information</span><span class="o">.</span><span class="n">identifiers</span><span class="p">,</span>
        <span class="n">timeseries_transformer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeseries_analyzer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">accuracy_functions</span><span class="o">=</span><span class="n">accuracy_functions</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="add_implicit_values"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.add_implicit_values">[docs]</a><span class="k">def</span> <span class="nf">add_implicit_values</span><span class="p">(</span><span class="n">json_ai</span><span class="p">:</span> <span class="n">JsonAI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonAI</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To enable brevity in writing, auto-generate the &quot;unspecified/missing&quot; details required in the ML pipeline.</span>

<span class="sd">    :params: json_ai: ``JsonAI`` object that describes the ML pipeline that may not have every detail fully specified.</span>

<span class="sd">    :returns: ``JSONAI`` object with all necessary parameters that were previously left unmentioned filled in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">problem_definition</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span>
    <span class="n">imports</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;from lightwood.model import Neural&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.model import LightGBM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.model import LightGBMArray&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.model import SkTime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.model import Unit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.model import Regression&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.ensemble import BestOf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.data import cleaner&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.data import transform_timeseries, timeseries_analyzer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.data import splitter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.analysis import model_analyzer, explain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from sklearn.metrics import r2_score, balanced_accuracy_score, accuracy_score&quot;</span><span class="p">,</span>
        <span class="s2">&quot;import pandas as pd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.helpers.seed import seed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.helpers.log import log&quot;</span><span class="p">,</span>
        <span class="s2">&quot;import lightwood&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.api import *&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.model import BaseModel&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.encoder import BaseEncoder, __ts_encoders__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.encoder import Array, Binary, Categorical, Date, Datetime, Float, Image, Integer, Quantity, Rich_Text, Short_Text, Tags&quot;</span><span class="p">,</span>  <span class="c1"># noqa</span>
        <span class="s2">&quot;from lightwood.ensemble import BaseEnsemble&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from typing import Dict, List&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.helpers.parallelism import mut_method_call&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood.data.encoded_ds import ConcatedEncodedDs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;from lightwood import ProblemDefinition&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">imports</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">imports</span> <span class="o">=</span> <span class="n">imports</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">imports</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">imports</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">values</span><span class="p">()]:</span>
        <span class="n">encoder_import</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">encoder</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">encoder_import</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">imports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;from lightwood.encoder import </span><span class="si">{encoder_import}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">use_previous_target</span><span class="p">:</span>
        <span class="n">imports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;from lightwood.encoder import TimeSeriesPlainEncoder&quot;</span><span class="p">)</span>

    <span class="c1"># Add implicit arguments</span>
    <span class="c1"># @TODO: Consider removing once we have a proper editor in studio</span>
    <span class="n">models</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">models</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Unit&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Neural&quot;</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;target_encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;$encoders[self.target]&quot;</span>
            <span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span>
            <span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;input_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;input_cols&quot;</span><span class="p">,</span> <span class="s2">&quot;$input_cols&quot;</span>
            <span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;timeseries_settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">,</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span>
            <span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;net&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;net&quot;</span><span class="p">,</span>
                <span class="s1">&#39;&quot;DefaultNet&quot;&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">is_timeseries</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">use_previous_target</span>
                <span class="k">else</span> <span class="s1">&#39;&quot;ArNet&quot;&#39;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LightGBM&quot;</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span>
            <span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;input_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;input_cols&quot;</span><span class="p">,</span> <span class="s2">&quot;$input_cols&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Regression&quot;</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span>
            <span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target_encoder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;target_encoder&quot;</span><span class="p">,</span> <span class="s2">&quot;$encoders[self.target]&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LightGBMArray&quot;</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span>
            <span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;input_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;input_cols&quot;</span><span class="p">,</span> <span class="s2">&quot;$input_cols&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;module&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SkTime&quot;</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;dtype_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;$dtype_dict&quot;</span>
            <span class="p">)</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;ts_analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;ts_analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;$ts_analysis&quot;</span>
            <span class="p">)</span>

    <span class="n">ensemble</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">ensemble</span>
    <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;$target&quot;</span><span class="p">)</span>
    <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;test_data&quot;</span><span class="p">)</span>
    <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="s2">&quot;models&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="s2">&quot;$models&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dependency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dependency</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">encoder</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">)</span>

    <span class="c1"># Add implicit phases</span>
    <span class="c1"># @TODO: Consider removing once we have a proper editor in studio</span>
    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">cleaner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">cleaner</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;cleaner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;pct_invalid&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.pct_invalid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ignore_features&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.ignore_features&quot;</span><span class="p">,</span>
                <span class="s2">&quot;identifiers&quot;</span><span class="p">:</span> <span class="s2">&quot;$identifiers&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;$mode&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;anomaly_detection&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.anomaly_detection&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">splitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;splitter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;tss&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="s2">&quot;nfolds&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">analyzer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;model_analyzer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;stats_info&quot;</span><span class="p">:</span> <span class="s2">&quot;$statistical_analysis&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ts_cfg&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;accuracy_functions&quot;</span><span class="p">:</span> <span class="s2">&quot;$accuracy_functions&quot;</span><span class="p">,</span>
                <span class="s2">&quot;predictor&quot;</span><span class="p">:</span> <span class="s2">&quot;$ensemble&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;test_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;train_data&quot;</span><span class="p">:</span> <span class="s2">&quot;train_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;disable_column_importance&quot;</span><span class="p">:</span> <span class="s2">&quot;False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fixed_significance&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;confidence_normalizer&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;positive_domain&quot;</span><span class="p">:</span> <span class="s2">&quot;$statistical_analysis.positive_domain&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">explainer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">explainer</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;explain&quot;</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;positive_domain&quot;</span><span class="p">:</span> <span class="s2">&quot;$statistical_analysis.positive_domain&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fixed_confidence&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.fixed_confidence&quot;</span><span class="p">,</span>
                <span class="s2">&quot;anomaly_detection&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.anomaly_detection&quot;</span><span class="p">,</span>
                <span class="s2">&quot;anomaly_error_rate&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.anomaly_error_rate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;anomaly_cooldown&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.anomaly_cooldown&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;encoded_data&quot;</span><span class="p">:</span> <span class="s2">&quot;encoded_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="s2">&quot;df&quot;</span><span class="p">,</span>
                <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="s2">&quot;$runtime_analyzer&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ts_analysis&quot;</span><span class="p">:</span> <span class="s2">&quot;$ts_analysis&quot;</span>
                <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">is_timeseries</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;target_name&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;target_dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict[self.target]&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">is_timeseries</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">timeseries_transformer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">json_ai</span><span class="o">.</span><span class="n">timeseries_transformer</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;transform_timeseries&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;$mode&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">timeseries_analyzer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">json_ai</span><span class="o">.</span><span class="n">timeseries_analyzer</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;timeseries_analyzer&quot;</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;timeseries_settings&quot;</span><span class="p">:</span> <span class="s2">&quot;$problem_definition.timeseries_settings&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dtype_dict&quot;</span><span class="p">:</span> <span class="s2">&quot;$dtype_dict&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;$target&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="n">json_ai</span></div>


<div class="viewcode-block" id="code_from_json_ai"><a class="viewcode-back" href="../../api/json_ai.html#api.json_ai.code_from_json_ai">[docs]</a><span class="k">def</span> <span class="nf">code_from_json_ai</span><span class="p">(</span><span class="n">json_ai</span><span class="p">:</span> <span class="n">JsonAI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a custom ``PredictorInterface`` given the specifications from ``JsonAI`` object.</span>

<span class="sd">    :param json_ai: ``JsonAI`` object with fully specified parameters</span>

<span class="sd">    :returns: Automated syntax of the ``PredictorInterface`` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fill in any missing values</span>
    <span class="n">json_ai</span> <span class="o">=</span> <span class="n">add_implicit_values</span><span class="p">(</span><span class="n">json_ai</span><span class="p">)</span>

    <span class="n">encoder_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span><span class="p">:</span> <span class="n">call</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">encoder</span><span class="p">,</span> <span class="n">json_ai</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="n">dependency_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dtype_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">target</span><span class="p">:</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;&#39;{list(json_ai.outputs.values())[0].data_dtype}&#39;&quot;&quot;&quot;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">col_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">ignore_features</span><span class="p">:</span>
            <span class="n">encoder_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">encoder</span><span class="p">,</span> <span class="n">json_ai</span><span class="p">)</span>
            <span class="n">dependency_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">dependency</span>
            <span class="n">dtype_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;&#39;</span><span class="si">{feature.data_dtype}</span><span class="s2">&#39;&quot;&quot;&quot;</span>

    <span class="c1"># @TODO: Move into json-ai creation function (I think? Maybe? Let&#39;s discuss)</span>
    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">use_previous_target</span><span class="p">:</span>
        <span class="n">col_name</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;__mdb_ts_previous_</span><span class="si">{json_ai.problem_definition.target}</span><span class="s2">&quot;</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">target_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span>
        <span class="n">encoder_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span><span class="p">(</span>
            <span class="n">lookup_encoder</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_dtype</span><span class="p">,</span>
                <span class="n">col_name</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">json_ai</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">dependency_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dtype_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;&#39;{list(json_ai.outputs.values())[0].data_dtype}&#39;&quot;&quot;&quot;</span>
        <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span><span class="n">encoder</span><span class="o">=</span><span class="n">encoder_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span>

    <span class="n">ignored_cols</span> <span class="o">=</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">ignore_features</span>
    <span class="n">input_cols</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="n">f</span><span class="s2">&quot;&quot;&quot;&#39;</span><span class="si">{name}</span><span class="s2">&#39;&quot;&quot;&quot;</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">features</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignored_cols</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">ts_transform_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ts_analyze_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ts_encoder_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">timeseries_transformer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts_transform_code</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">log.info(&#39;Transforming timeseries data&#39;)</span>
<span class="s2">data = {call(json_ai.timeseries_transformer, json_ai)}</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">ts_analyze_code</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">self.ts_analysis = {call(json_ai.timeseries_analyzer, json_ai)}</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">timeseries_analyzer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts_encoder_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">if type(encoder) in __ts_encoders__:</span>
<span class="s2">    kwargs[&#39;ts_analysis&#39;] = self.ts_analysis</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">json_ai</span><span class="o">.</span><span class="n">problem_definition</span><span class="o">.</span><span class="n">timeseries_settings</span><span class="o">.</span><span class="n">is_timeseries</span><span class="p">:</span>
        <span class="n">ts_target_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">if encoder.is_target:</span>
<span class="s2">    encoder.normalizers = self.ts_analysis[&#39;target_normalizers&#39;]</span>
<span class="s2">    encoder.group_combinations = self.ts_analysis[&#39;group_combinations&#39;]</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ts_target_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">dataprep_body</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># The type of each column</span>
<span class="s2">self.problem_definition = ProblemDefinition.from_dict({json_ai.problem_definition.to_dict()})</span>
<span class="s2">self.accuracy_functions = </span><span class="si">{json_ai.accuracy_functions}</span><span class="s2"></span>
<span class="s2">self.identifiers = </span><span class="si">{json_ai.identifiers}</span><span class="s2"></span>
<span class="s2">self.dtype_dict = {inline_dict(dtype_dict)}</span>
<span class="s2">self.statistical_analysis = lightwood.data.statistical_analysis(data, self.dtype_dict, </span><span class="si">{json_ai.identifiers}</span><span class="s2">,</span>
<span class="s2">                                                                self.problem_definition)</span>
<span class="s2">self.mode = &#39;train&#39;</span>
<span class="s2"># How columns are encoded</span>
<span class="s2">self.encoders = {inline_dict(encoder_dict)}</span>
<span class="s2"># Which column depends on which</span>
<span class="s2">self.dependencies = {inline_dict(dependency_dict)}</span>
<span class="s2">#</span>
<span class="s2">self.input_cols = [</span><span class="si">{input_cols}</span><span class="s2">]</span>

<span class="s2">log.info(&#39;Cleaning the data&#39;)</span>
<span class="s2">data = {call(json_ai.cleaner, json_ai)}</span>

<span class="si">{ts_transform_code}</span><span class="s2"></span>
<span class="si">{ts_analyze_code}</span><span class="s2"></span>

<span class="s2">nfolds = </span><span class="si">{json_ai.problem_definition.nfolds}</span><span class="s2"></span>
<span class="s2">log.info(f&#39;Splitting the data into {{nfolds}} folds&#39;)</span>
<span class="s2">folds = {call(json_ai.splitter, json_ai)}</span>

<span class="s2">log.info(&#39;Preparing the encoders&#39;)</span>

<span class="s2">encoder_preping_dict = {{}}</span>
<span class="s2">enc_preping_data = pd.concat(folds[0:nfolds-1])</span>
<span class="s2">for col_name, encoder in self.encoders.items():</span>
<span class="s2">    if not encoder.is_nn_encoder:</span>
<span class="s2">        encoder_preping_dict[col_name] = [encoder, enc_preping_data[col_name], &#39;prepare&#39;]</span>
<span class="s2">        log.info(f&#39;Encoder preping dict length of: {{len(encoder_preping_dict)}}&#39;)</span>

<span class="s2">parallel_preped_encoders = mut_method_call(encoder_preping_dict)</span>
<span class="s2">for col_name, encoder in parallel_preped_encoders.items():</span>
<span class="s2">    self.encoders[col_name] = encoder</span>

<span class="s2">if self.target not in parallel_preped_encoders:</span>
<span class="s2">    self.encoders[self.target].prepare(enc_preping_data[self.target])</span>

<span class="s2">for col_name, encoder in self.encoders.items():</span>
<span class="s2">    if encoder.is_nn_encoder:</span>
<span class="s2">        priming_data = pd.concat(folds[0:nfolds-1])</span>
<span class="s2">        kwargs = {{}}</span>
<span class="s2">        if self.dependencies[col_name]:</span>
<span class="s2">            kwargs[&#39;dependency_data&#39;] = {{}}</span>
<span class="s2">            for col in self.dependencies[col_name]:</span>
<span class="s2">                kwargs[&#39;dependency_data&#39;][col] = {{</span>
<span class="s2">                    &#39;original_type&#39;: self.dtype_dict[col],</span>
<span class="s2">                    &#39;data&#39;: priming_data[col]</span>
<span class="s2">                }}</span>
<span class="s2">            {align(ts_encoder_code, 3)}</span>

<span class="s2">        # This assumes target  encoders are also prepared in parallel, might not be true</span>
<span class="s2">        if hasattr(encoder, &#39;uses_target&#39;):</span>
<span class="s2">            kwargs[&#39;encoded_target_values&#39;] = parallel_preped_encoders[self.target].encode(priming_data[self.target])</span>

<span class="s2">        encoder.prepare(priming_data[col_name], **kwargs)</span>

<span class="s2">    {align(ts_target_code, 1)}</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">dataprep_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">dataprep_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">learn_body</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">log.info(&#39;Featurizing the data&#39;)</span>
<span class="s2">encoded_ds_arr = lightwood.encode(self.encoders, folds, self.target)</span>
<span class="s2">train_data = encoded_ds_arr[0:int(nfolds*0.9)]</span>
<span class="s2">test_data = encoded_ds_arr[int(nfolds*0.9):]</span>

<span class="s2">log.info(&#39;Training the models&#39;)</span>
<span class="s2">self.models = [{&#39;, &#39;.join([call(x, json_ai) for x in list(json_ai.outputs.values())[0].models])}]</span>
<span class="s2">trained_models = []</span>
<span class="s2">for model in self.models:</span>
<span class="s2">    try:</span>
<span class="s2">        model.fit(train_data)</span>
<span class="s2">        trained_models.append(model)</span>
<span class="s2">    except Exception as e:</span>
<span class="s2">        log.warning(f&#39;Exception: {{e}} when training model: {{model}}&#39;)</span>
<span class="s2">        if </span><span class="si">{json_ai.problem_definition.strict_mode}</span><span class="s2"> and model.stable:</span>
<span class="s2">            raise e</span>

<span class="s2">self.models = trained_models</span>

<span class="s2">log.info(&#39;Ensembling the model&#39;)</span>
<span class="s2">self.ensemble = {call(list(json_ai.outputs.values())[0].ensemble, json_ai)}</span>
<span class="s2">self.supports_proba = self.ensemble.supports_proba</span>

<span class="s2">log.info(&#39;Analyzing the ensemble&#39;)</span>
<span class="s2">self.model_analysis, self.runtime_analyzer = {call(json_ai.analyzer, json_ai)}</span>

<span class="s2"># Enable partial fit of model, after its trained, on validation data. This is ONLY to be used in cases where there is an expectation of testing data and a continuously evolving pipeline; this assumes that all data available is important to train with.</span>
<span class="s2">for model in self.models:</span>
<span class="s2">    if </span><span class="si">{json_ai.problem_definition.fit_on_validation}</span><span class="s2">:</span>
<span class="s2">        model.partial_fit(test_data, train_data)</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">learn_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">learn_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">predict_common_body</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">self.mode = &#39;predict&#39;</span>
<span class="s2">log.info(&#39;Cleaning the data&#39;)</span>
<span class="s2">data = {call(json_ai.cleaner, json_ai)}</span>

<span class="si">{ts_transform_code}</span><span class="s2"></span>

<span class="s2">encoded_ds = lightwood.encode(self.encoders, data, self.target)[0]</span>
<span class="s2">encoded_data = encoded_ds.get_encoded_data(include_target=False)</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">predict_common_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">predict_common_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">predict_body</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">df = self.ensemble(encoded_ds)</span>
<span class="s2">insights = {call(json_ai.explainer, json_ai)}</span>
<span class="s2">return insights</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">predict_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">predict_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">predict_proba_body</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">df = self.ensemble(encoded_ds, predict_proba=True)</span>
<span class="s2">insights = {call(json_ai.explainer, json_ai)}</span>
<span class="s2">return insights</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">predict_proba_body</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">predict_proba_body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">imports</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">json_ai</span><span class="o">.</span><span class="n">imports</span><span class="p">)</span>
    <span class="n">predictor_code</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">{imports}</span><span class="s2"></span>
<span class="s2">from lightwood.api import PredictorInterface</span>


<span class="s2">class Predictor(PredictorInterface):</span>
<span class="s2">    target: str</span>
<span class="s2">    models: List[BaseModel]</span>
<span class="s2">    encoders: Dict[str, BaseEncoder]</span>
<span class="s2">    ensemble: BaseEnsemble</span>
<span class="s2">    mode: str</span>

<span class="s2">    def __init__(self):</span>
<span class="s2">        seed()</span>
<span class="s2">        self.target = &#39;</span><span class="si">{json_ai.problem_definition.target}</span><span class="s2">&#39;</span>
<span class="s2">        self.mode = &#39;innactive&#39;</span>

<span class="s2">    def learn(self, data: pd.DataFrame) -&gt; None:</span>
<span class="si">{dataprep_body}</span><span class="s2"></span>
<span class="si">{learn_body}</span><span class="s2"></span>

<span class="s2">    def predict(self, data: pd.DataFrame) -&gt; pd.DataFrame:</span>
<span class="si">{predict_common_body}</span><span class="s2"></span>
<span class="si">{predict_body}</span><span class="s2"></span>


<span class="s2">    def predict_proba(self, data: pd.DataFrame) -&gt; pd.DataFrame:</span>
<span class="si">{predict_common_body}</span><span class="s2"></span>
<span class="si">{predict_proba_body}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictor_code</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">:</span>
        <span class="n">predictor_code</span> <span class="o">=</span> <span class="n">autopep8</span><span class="o">.</span><span class="n">fix_code</span><span class="p">(</span><span class="n">predictor_code</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predictor_code</span></div>


<span class="k">def</span> <span class="nf">validate_json_ai</span><span class="p">(</span><span class="n">json_ai</span><span class="p">:</span> <span class="n">JsonAI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">lightwood.api.high_level</span> <span class="k">import</span> <span class="n">predictor_from_code</span><span class="p">,</span> <span class="n">code_from_json_ai</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">predictor_from_code</span><span class="p">(</span><span class="n">code_from_json_ai</span><span class="p">(</span><span class="n">json_ai</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2021, MindsDB.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>